## コンパイル処理

前処理 -> 変換処理 -> 結合

- プリプロセッサ - プリプロセス
    - コンパイラ - コンパイル
        - リンカ - リンク

### プリプロセッサ

入力プログラムを、それと同じ言語だが
異なる内容にしたプログラムを出力する

今回でいうと、.asmファイルを受け取り
後続処理が解釈しやすい.asmファイルを出力する

```
%define cat_count 42

mov rax, cat_count
```

```
$ nasm -E define_cat_count.asm
%line 2+1 define_cat_count.asm

mov rax, 42
```

プリプロセスにより
cat_count　が定義した42で置き換えられる

**NASMでは既存のプリプロセッサシンボル(広義にいう変数シンボル)を再定義できる**

single line のマクロは `%define` が使われる
マクロ内で他のマクロを呼ぶこともできる

### コンパイラ

前段で処理したソースファイルをマシン語の命令に変換し
エンコードされたオブジェクトファイルを出力する

ここまでだと、複数ファイルがコンパイルされた場合に
それぞれの依存がある場合を解決できていない

#### マクロ

- 入力に依存する計算はできない(使えるのは定数のみ)
- 繰り返しのサイクルは固定回数より多くできない -> whileは不可

### リンカ

コンパイル処理で生成された成果物を結合して実行可能なファイルを作る

### ローダ

実行可能バイナリを受け取る
プロセス実行時のアドレスに受け取ったファイルの命令など
メタデータを書き込む

オペレーティングシステムの一部
実行可能なファイルの実行準備を行う
メモリに移せる部分をメモリにマッピングしたりする

### セクション

プログラムの分割単位。
どのような特性を持ったメモリにどんなデータをどこから(アドレス)置くかという情報をもつ

なぜ必要かというと、ファイルの中にあるプログラムを用途にあったメモリに預けたい。または割り振る必要がある。
なぜなら、機械語の実行バイナリを再起動でフラッシュされるようなメモリには置けないし
かといって、全てをRAMに預けようとしても、MMUは機械御用のメモリとそれ以外を区別するので
どのメモリに割り振るべきかのメタ情報が必要だから。

```
objdump -h `ファイル名`
```
で見れる

**参考**
http://www.ertl.jp/~takayuki/readings/info/no02.html

### .bss

セクションの１つ
プログラムのうち、初期値を持たない変数を格納するセクション

### .text

プログラムのうち、機械語の部分を格納するためのセクション

### .data

プログラムのうち、初期値を持つ変数を格納するためのセクション

### リンク

```
$ ld -o [binary] file.o
```

ldというリンカを呼び出す

#### ELF Executable and Linkable Format

実行とリンクが可能なフォーマット

3種類のファイルをサポート

- 再配置可能なオブジェクトファイル
    - コンパイラが生成する `.o` ファイル
    - プログラムの各部に決定的なアドレスを割り当てて、モジュール間の参照が適切に行えるようにする
- 実行可能なオブジェクトファイル
    - そのままメモリにロードして実行できるファイル
        - コードとデータとユーティリティ情報をもったストレージ
- 共有オブジェクトファイル
    - `必要なとき` メインプログラムがロードできるファイル
    - 動的にリンクできるので動的ライブラリとも呼ばれる
    - windowsでは`.dll`, *nixでは `***.so`で終わることが多い(shared object)

リンカは、再配置可能なオブジェクトファイルの集合を受け取って
`1個` の実行可能な(または共有可能な)オブジェクトファイルを作る

### *nix 

just means operating systems that are like the old workhorse Unix. 
Some examples include Linux, FreeBSD, and Mac OS X (its kernel, Darwin, is based on BSD).

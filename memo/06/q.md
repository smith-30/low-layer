### NMI non-maskable interrupt とは何か、2番割り込み、IFフラグとの関係は?

2番割り込み -> NMIに対応している割り込みベクタテーブルの番号
             この番号を元に割り込みサービスを呼び出す

IFフラグ -> Intel CPUにはハードウェアからの割り込みを受けるための
`INTR` と `NMI` pin がある
これらのpin にパルスが入るとCPUはハードウェア割り込み処理を行う
NMIは、IFフラグをクリアしても無効にできないクリティカルなイベントに利用される
マスクで無効にできない重要な割り込みか。

INTRは、`eflags`レジスタのIFフラグをクリアすることで無効にできる
ソフトウェアでマスク可能な割り込みを発生させる

### TF(トラップフラグ)は割り込みハンドラに入るとき自動的にクリアされるか


### 割り込みとは何か

現在実行中のプログラムやタスクから
実行を強制的に割り込みハンドラと呼ばれる処理に移行することを言います

割り込みは通常、プログラムの実行中に周辺装置へのサービス要求のような
プロセッサにとって外部的なイベントをハードウェアから要求を受けたときに起こる
また、アプリケーション側からも INT n 命令を実行することにより割り込みを生成できる

### IDTとは何か

Interrupt Descriptor Table

割り込みと割り込みハンドラを結びつけるテーブル
`8 byte` のディスクリプタ


### IF をセットすると何が変わるのか

ソフトウェア割り込みでは、セットされていようがいまいが無視されてハンドラが呼ばれる

セットされていると、その他の割り込み/例外を許可する
トラップゲートディスクリプタなど

割り込みゲートディスクリプタでは、EFLAGSレジスタのIFをクリアし
割り込み処理中は他の割り込みが入らないようにする。要は上位の命令?

### #GP エラーが発生するのはどういう状況か

どのページにも割り当てられていない不正なアドレスをデリファレンスしようとしたり
より高い権限を必要とする処理を実行しようとしたとき

デリファレンス -> アドレス(ポインタ)を見に行くこと

### #PF エラーが発生するのはどういう状況か

あるページをアドレッシングしたとき、それに対応するページテーブルエントリで
Present フラグがクリアされていたときに生成される

### #PF エラーとスワッピングの関係は? OSはそれをどう使うのか

ページの要求に失敗したときに発生するエラーなので
OSがディスクにページをロードするように命令を出す

### システムコールは割り込みを使って実装できるか

割り込みを発生させる命令を使用してシステムコールを実装できる

### システムコールの実装に特別な命令が必要な理由は?

IDTへのメモリアクセスが必要な割り込みに比べて高速な処理を期待できるから
具体的には、全てのシステムコールは1つのエンドポイントを叩くようになっていて
IDTのように`どの`を探す必要がない

### なぜ割り込みハンドラがDPLフィールドを必要とするのか

引数として割り込み番号をとる特別なint命令を行うときに
現在の特権レベルがDPLより小さいか等しい場合にしかそのハンドラを呼び出せないようにするため
Todo ↑現在とは

これがないと、割り込み処理がコンピュータになんでも命令を出せるようになってしまう

### 割り込みスタックテーブル(IST)の目的は

割り込みハンドラのために、既知の良好なスタックを提供する

### シングルスレッドアプリケーションが持つスタックは1つだけだろうか

アプリケーションはスレッドごとにユーザスタックを持つし
スレッドごとにカーネルスタックも持つ

アプリケーションの命令はユーザスタックを利用して行い
割り込みなど特殊な処理はカーネルスタックで行う
ユーザスタックとカーネルスタックを行き来している

スレッド: プロセスの子タスクとしてプロセスとメモリを共有して動かす。親プロセスの領域内に存在する
        そのため、ロックを使って共有するメモリは排他制御する必要がある
プロセス: 子プロセスは、親プロセスからフォークして生成される。
        そのため、メモリが新規に割り振られる。
        親プロセスのデータセグメントをコピーして、その子プロセス専用のデータセグメントを確保
        動かすプログラムの命令自体は親プロセスと同じなので
        テキストセグメントは親プロセスと同じ領域を指す

参考
https://moro-archive.hatenablog.com/entry/2014/09/11/013520

### Intel64は入出力機構として何を提供しているか

I/Oポート
これで、CPUとデバイスの間でデータを交換する

専用I/Oアドレス空間
データを交換するには in or out 命令を使う

memory mapped I/O
CPUが相手を気にせずメモリをアドレッシングする処理を行える


### シャドーレジスタとは

割り込み時の状態を対比させておくキャッシュレジスタ。
スタックに積むより高速


### モデル固有レジスタはシステムコールの機構でどう使われるか

- STARからcsをロード
- rflagsをSFMASKの値でマスク
- ripをrcxに保存してから LSTARの値でripを初期化
- csとssの値をSTARから得る

### syscall 命令では、どのレジスタが使われるか

- STAR, SFMASK, LSTAR
- rcx, r11(古いripとrflagsを保存するため)

https://www.wdic.org/w/SCI/syscall
